# Ephemeral Token System Setup Guide

This guide explains how to set up the ephemeral token system for secure Gemini API access.

## Overview

The ephemeral token system replaces hardcoded API keys with short-lived tokens generated by a backend server. This provides:

- ✅ **Security**: API keys are never exposed to the client
- ✅ **Rate Limiting**: Tokens have usage limits (10 requests per token)
- ✅ **Expiration**: Tokens expire after 15 minutes
- ✅ **Scalability**: Multiple API keys can be rotated

## Architecture

```
Frontend (Browser)
    ↓ Requests ephemeral token
Backend Server (Node.js)
    ↓ Validates & generates token
    ↓ Proxies API calls with real Gemini API keys
Google Gemini API
```

## Setup Instructions

### 1. Install Dependencies

```bash
npm install
```

This installs:
- `express` - Web server framework
- `cors` - Cross-origin resource sharing
- `node-fetch` - HTTP client for Node.js

### 2. Configure Environment Variables

Create a `.env` file in the root directory:

```env
# Gemini API Keys (Get these from Google AI Studio)
GEMINI_API_KEY_PRIMARY=your_primary_api_key_here
GEMINI_API_KEY_SECONDARY=your_secondary_api_key_here

# Server Configuration
PORT=3000

# Environment
NODE_ENV=production
```

**Important**: Never commit `.env` to version control. It's already in `.gitignore`.

### 3. Get Gemini API Keys

1. Visit [Google AI Studio](https://aistudio.google.com/app/apikey)
2. Create API keys for your project
3. Add them to your `.env` file

### 4. Configure Frontend API Base URL

**For Development (Localhost):**
No changes needed! The system automatically detects `localhost` and uses:
```
http://localhost:3000/api
```

**For Production:**

Open `js/ai-token-manager.js` and find lines **200-205**. You have two options:

**Option 1: Same domain as frontend** (backend on `/api` path)
```javascript
// No changes needed - already configured
const API_BASE_URL = isLocalhost 
    ? 'http://localhost:3000/api'
    : window.location.origin + '/api';  // Uses same domain
```

**Option 2: Different domain** (backend on separate domain)
```javascript
// Change line 202 to your backend URL:
const API_BASE_URL = isLocalhost 
    ? 'http://localhost:3000/api'
    : 'https://your-backend-domain.com/api';  // Change this!
```

**Or use the alternative** (line 204-205):
```javascript
// Uncomment and set your backend URL:
const API_BASE_URL = 'https://your-backend-domain.com/api';
```

**Examples:**
- `https://api.yoursite.com/api`
- `https://backend.yoursite.com/api`
- `https://fast-papers-backend.herokuapp.com/api`

See `QUICK_START.md` for detailed instructions.

### 5. Start the Backend Server

**Development:**
```bash
npm run dev
```

**Production:**
```bash
npm start
```

The server will start on `http://localhost:3000` (or the port specified in `.env`).

### 6. Verify Setup

1. Check server health:
   ```bash
   curl http://localhost:3000/api/health
   ```

2. Test token generation:
   ```bash
   curl -X POST http://localhost:3000/api/token/generate
   ```

3. Open your website and test the AI Generate feature.

## API Endpoints

### `POST /api/token/generate`

Generates a new ephemeral token.

**Response:**
```json
{
  "success": true,
  "token": "abc123...",
  "expiresAt": 1234567890,
  "expiresIn": 900
}
```

### `POST /api/gemini/models`

Lists available Gemini models. Requires token in header.

**Headers:**
```
X-API-Token: your_token_here
```

**Response:**
```json
{
  "success": true,
  "models": [...]
}
```

### `POST /api/gemini/generate`

Generates content using Gemini API. Requires token in header.

**Headers:**
```
X-API-Token: your_token_here
Content-Type: application/json
```

**Body:**
```json
{
  "prompt": "Your prompt here",
  "model": "gemini-2.5-flash"
}
```

**Response:**
```json
{
  "success": true,
  "model": "gemini-2.5-flash",
  "text": "Generated content...",
  "usageMetadata": {...}
}
```

## Token Lifecycle

1. **Generation**: Token is created when frontend requests it
2. **Validation**: Each API call validates the token
3. **Usage Tracking**: Token usage count increments with each request
4. **Expiration**: Token expires after 15 minutes OR 10 requests
5. **Cleanup**: Expired tokens are automatically removed

## Security Features

### Token Limits

- **Expiry Time**: 15 minutes from generation
- **Max Usage**: 10 API requests per token
- **Auto-cleanup**: Expired tokens removed every 5 minutes

### Rate Limiting

The server implements per-token rate limiting:
- Each token can make up to 10 requests
- After 10 requests, token is invalidated
- Frontend automatically requests new token when needed

### Error Handling

Common errors:

- **401 Unauthorized**: Invalid or expired token
- **429 Too Many Requests**: Token usage limit exceeded
- **500 Internal Server Error**: Server or API configuration issue

## Deployment

### Production Considerations

1. **Use HTTPS**: Always use HTTPS in production for secure token transmission

2. **Environment Variables**: Set environment variables on your hosting platform:
   - Vercel: Project Settings → Environment Variables
   - Heroku: `heroku config:set KEY=value`
   - Railway: Project → Variables

3. **CORS Configuration**: Update CORS settings in `server.js` to allow your frontend domain only:
   ```javascript
   app.use(cors({
     origin: 'https://your-frontend-domain.com'
   }));
   ```

4. **API Key Rotation**: Use multiple API keys and rotate them:
   ```javascript
   const apiKey = roundRobinKeySelector(); // Implement your logic
   ```

5. **Monitoring**: Add logging and monitoring:
   ```javascript
   // Log token generation
   console.log(`Token generated: ${token.substring(0, 8)}...`);
   ```

6. **Redis (Optional)**: For production, replace in-memory token store with Redis:
   ```javascript
   const redis = require('redis');
   const client = redis.createClient();
   // Store tokens in Redis instead of Map
   ```

## Troubleshooting

### Frontend Error: "AI Token Manager not loaded"

**Solution**: Ensure `ai-token-manager.js` is included before AI generate scripts in HTML.

### Backend Error: "Failed to generate token"

**Solution**: Check that the server is running and accessible from the frontend.

### API Error: "Invalid or expired token"

**Solution**: This is normal when token expires. The frontend will automatically request a new token.

### CORS Error

**Solution**: Update CORS configuration in `server.js` to include your frontend URL.

## Files Changed

### Backend
- ✅ `server.js` - Backend server with token generation and API proxy
- ✅ `package.json` - Dependencies and scripts
- ✅ `.gitignore` - Added `.env` to ignore

### Frontend
- ✅ `js/ai-token-manager.js` - Token management utility
- ✅ `js/ai-generate*.js` - Updated all AI generate classes (8 files)
- ✅ `subjects/*.html` - Updated all subject pages to include token manager

## Migration Notes

All hardcoded API keys have been removed from frontend code. The system now:

1. Requests ephemeral tokens from backend
2. Uses tokens for all Gemini API calls
3. Automatically handles token expiration
4. Provides better error messages

No changes needed to existing functionality - everything works the same from the user's perspective!

## Support

If you encounter issues:

1. Check server logs for errors
2. Verify environment variables are set correctly
3. Test API endpoints manually with curl/Postman
4. Check browser console for frontend errors

